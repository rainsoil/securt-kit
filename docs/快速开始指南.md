# 字段加密解密快速开始指南

## 1. 环境要求

- JDK 8+
- Spring Boot 2.x
- MyBatis 或 MyBatis Plus
- Maven 或 Gradle

## 2. 添加依赖

### 2.1 在项目中添加依赖

```xml
<!-- 在项目的pom.xml中添加 -->
<dependency>
    <groupId>com.chu7.securtkit</groupId>
    <artifactId>securt-kit-core</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

### 2.2 确保已有依赖

```xml
<dependencies>
    <!-- Spring Boot Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter</artifactId>
    </dependency>
    
    <!-- MyBatis -->
    <dependency>
        <groupId>org.mybatis.spring.boot</groupId>
        <artifactId>mybatis-spring-boot-starter</artifactId>
        <version>2.2.0</version>
    </dependency>
    
    <!-- 数据库驱动 -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <scope>runtime</scope>
    </dependency>
</dependencies>
```

## 3. 配置加密功能

### 3.1 在application.yml中配置

```yaml
# application.yml
securt-kit:
  encrypt:
    enabled: true
    algorithm: AES
    key: ${ENCRYPT_KEY:your-secret-key-32-chars}
    fields:
      user_info:
        - phone
        - email
        - id_card
      order_info:
        - customer_name
        - customer_phone
    exclude-tables:
      - system_config
      - log_info

# 数据库配置
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test?useSSL=false&serverTimezone=UTC
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver

# MyBatis配置
mybatis:
  configuration:
    map-underscore-to-camel-case: true
  mapper-locations: classpath:mapper/*.xml
```

### 3.2 设置环境变量（推荐）

```bash
# Linux/Mac
export ENCRYPT_KEY="your-secret-key-32-chars"

# Windows
set ENCRYPT_KEY=your-secret-key-32-chars
```

## 4. 创建数据库表

```sql
-- 创建用户信息表
CREATE TABLE user_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    phone VARCHAR(255) COMMENT '手机号（加密）',
    email VARCHAR(255) COMMENT '邮箱（加密）',
    id_card VARCHAR(255) COMMENT '身份证号（加密）',
    name VARCHAR(100) COMMENT '姓名',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建订单信息表
CREATE TABLE order_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) COMMENT '订单号',
    customer_name VARCHAR(255) COMMENT '客户姓名（加密）',
    customer_phone VARCHAR(255) COMMENT '客户手机号（加密）',
    amount DECIMAL(10,2) COMMENT '订单金额',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 5. 创建实体类

### 5.1 用户信息实体

```java
package com.example.entity;

import com.chu7.securtkit.encrypt.annotation.EncryptField;
import java.time.LocalDateTime;

public class UserInfo {
    private Long id;
    
    @EncryptField
    private String phone;
    
    @EncryptField(algorithm = "AES")
    private String email;
    
    @EncryptField
    private String idCard;
    
    private String name;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    
    // getters and setters
    public Long getId() {
        return id;
    }
    
    public void setId(Long id) {
        this.id = id;
    }
    
    public String getPhone() {
        return phone;
    }
    
    public void setPhone(String phone) {
        this.phone = phone;
    }
    
    public String getEmail() {
        return email;
    }
    
    public void setEmail(String email) {
        this.email = email;
    }
    
    public String getIdCard() {
        return idCard;
    }
    
    public void setIdCard(String idCard) {
        this.idCard = idCard;
    }
    
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
    
    public LocalDateTime getCreateTime() {
        return createTime;
    }
    
    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }
    
    public LocalDateTime getUpdateTime() {
        return updateTime;
    }
    
    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }
}
```

### 5.2 订单信息实体

```java
package com.example.entity;

import com.chu7.securtkit.encrypt.annotation.EncryptField;
import java.math.BigDecimal;
import java.time.LocalDateTime;

public class OrderInfo {
    private Long id;
    private String orderNo;
    
    @EncryptField
    private String customerName;
    
    @EncryptField
    private String customerPhone;
    
    private BigDecimal amount;
    private LocalDateTime createTime;
    
    // getters and setters
    public Long getId() {
        return id;
    }
    
    public void setId(Long id) {
        this.id = id;
    }
    
    public String getOrderNo() {
        return orderNo;
    }
    
    public void setOrderNo(String orderNo) {
        this.orderNo = orderNo;
    }
    
    public String getCustomerName() {
        return customerName;
    }
    
    public void setCustomerName(String customerName) {
        this.customerName = customerName;
    }
    
    public String getCustomerPhone() {
        return customerPhone;
    }
    
    public void setCustomerPhone(String customerPhone) {
        this.customerPhone = customerPhone;
    }
    
    public BigDecimal getAmount() {
        return amount;
    }
    
    public void setAmount(BigDecimal amount) {
        this.amount = amount;
    }
    
    public LocalDateTime getCreateTime() {
        return createTime;
    }
    
    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }
}
```

## 6. 创建Mapper接口

### 6.1 用户信息Mapper

```java
package com.example.mapper;

import com.example.entity.UserInfo;
import org.apache.ibatis.annotations.*;

import java.util.List;

@Mapper
public interface UserInfoMapper {
    
    @Insert("INSERT INTO user_info(phone, email, id_card, name) VALUES(#{phone}, #{email}, #{idCard}, #{name})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insert(UserInfo userInfo);
    
    @Select("SELECT * FROM user_info WHERE id = #{id}")
    UserInfo selectById(Long id);
    
    @Select("SELECT * FROM user_info")
    List<UserInfo> selectAll();
    
    @Update("UPDATE user_info SET phone=#{phone}, email=#{email}, id_card=#{idCard}, name=#{name} WHERE id=#{id}")
    int update(UserInfo userInfo);
    
    @Delete("DELETE FROM user_info WHERE id = #{id}")
    int deleteById(Long id);
}
```

### 6.2 订单信息Mapper

```java
package com.example.mapper;

import com.example.entity.OrderInfo;
import org.apache.ibatis.annotations.*;

import java.util.List;

@Mapper
public interface OrderInfoMapper {
    
    @Insert("INSERT INTO order_info(order_no, customer_name, customer_phone, amount) VALUES(#{orderNo}, #{customerName}, #{customerPhone}, #{amount})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insert(OrderInfo orderInfo);
    
    @Select("SELECT * FROM order_info WHERE id = #{id}")
    OrderInfo selectById(Long id);
    
    @Select("SELECT * FROM order_info")
    List<OrderInfo> selectAll();
    
    @Update("UPDATE order_info SET customer_name=#{customerName}, customer_phone=#{customerPhone}, amount=#{amount} WHERE id=#{id}")
    int update(OrderInfo orderInfo);
    
    @Delete("DELETE FROM order_info WHERE id = #{id}")
    int deleteById(Long id);
}
```

## 7. 创建Service层

### 7.1 用户信息服务

```java
package com.example.service;

import com.example.entity.UserInfo;
import com.example.mapper.UserInfoMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class UserInfoService {
    
    @Autowired
    private UserInfoMapper userInfoMapper;
    
    public void createUser(UserInfo userInfo) {
        // phone、email、idCard字段会自动加密
        userInfoMapper.insert(userInfo);
    }
    
    public UserInfo getUserById(Long id) {
        // phone、email、idCard字段会自动解密
        return userInfoMapper.selectById(id);
    }
    
    public List<UserInfo> getAllUsers() {
        // 所有加密字段会自动解密
        return userInfoMapper.selectAll();
    }
    
    public void updateUser(UserInfo userInfo) {
        // 更新时加密字段会自动加密
        userInfoMapper.update(userInfo);
    }
    
    public void deleteUser(Long id) {
        userInfoMapper.deleteById(id);
    }
}
```

### 7.2 订单信息服务

```java
package com.example.service;

import com.example.entity.OrderInfo;
import com.example.mapper.OrderInfoMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class OrderInfoService {
    
    @Autowired
    private OrderInfoMapper orderInfoMapper;
    
    public void createOrder(OrderInfo orderInfo) {
        // customerName、customerPhone字段会自动加密
        orderInfoMapper.insert(orderInfo);
    }
    
    public OrderInfo getOrderById(Long id) {
        // customerName、customerPhone字段会自动解密
        return orderInfoMapper.selectById(id);
    }
    
    public List<OrderInfo> getAllOrders() {
        // 所有加密字段会自动解密
        return orderInfoMapper.selectAll();
    }
    
    public void updateOrder(OrderInfo orderInfo) {
        // 更新时加密字段会自动加密
        orderInfoMapper.update(orderInfo);
    }
    
    public void deleteOrder(Long id) {
        orderInfoMapper.deleteById(id);
    }
}
```

## 8. 创建Controller层

```java
package com.example.controller;

import com.example.entity.UserInfo;
import com.example.entity.OrderInfo;
import com.example.service.UserInfoService;
import com.example.service.OrderInfoService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api")
public class ApiController {
    
    @Autowired
    private UserInfoService userInfoService;
    
    @Autowired
    private OrderInfoService orderInfoService;
    
    // 用户相关接口
    @PostMapping("/users")
    public void createUser(@RequestBody UserInfo userInfo) {
        userInfoService.createUser(userInfo);
    }
    
    @GetMapping("/users/{id}")
    public UserInfo getUser(@PathVariable Long id) {
        return userInfoService.getUserById(id);
    }
    
    @GetMapping("/users")
    public List<UserInfo> getAllUsers() {
        return userInfoService.getAllUsers();
    }
    
    @PutMapping("/users")
    public void updateUser(@RequestBody UserInfo userInfo) {
        userInfoService.updateUser(userInfo);
    }
    
    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable Long id) {
        userInfoService.deleteUser(id);
    }
    
    // 订单相关接口
    @PostMapping("/orders")
    public void createOrder(@RequestBody OrderInfo orderInfo) {
        orderInfoService.createOrder(orderInfo);
    }
    
    @GetMapping("/orders/{id}")
    public OrderInfo getOrder(@PathVariable Long id) {
        return orderInfoService.getOrderById(id);
    }
    
    @GetMapping("/orders")
    public List<OrderInfo> getAllOrders() {
        return orderInfoService.getAllOrders();
    }
    
    @PutMapping("/orders")
    public void updateOrder(@RequestBody OrderInfo orderInfo) {
        orderInfoService.updateOrder(orderInfo);
    }
    
    @DeleteMapping("/orders/{id}")
    public void deleteOrder(@PathVariable Long id) {
        orderInfoService.deleteOrder(id);
    }
}
```

## 9. 测试功能

### 9.1 启动应用

```bash
mvn spring-boot:run
```

### 9.2 测试用户接口

```bash
# 创建用户
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "email": "test@example.com",
    "idCard": "110101199001011234",
    "name": "张三"
  }'

# 查询用户
curl http://localhost:8080/api/users/1

# 查询所有用户
curl http://localhost:8080/api/users
```

### 9.3 测试订单接口

```bash
# 创建订单
curl -X POST http://localhost:8080/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "orderNo": "ORD20231201001",
    "customerName": "李四",
    "customerPhone": "13900139000",
    "amount": 99.99
  }'

# 查询订单
curl http://localhost:8080/api/orders/1

# 查询所有订单
curl http://localhost:8080/api/orders
```

## 10. 验证加密效果

### 10.1 查看数据库中的加密数据

```sql
-- 查看用户表中的加密数据
SELECT * FROM user_info;

-- 查看订单表中的加密数据
SELECT * FROM order_info;
```

您会看到：
- `phone`、`email`、`id_card` 字段存储的是加密后的Base64字符串
- `customer_name`、`customer_phone` 字段存储的是加密后的Base64字符串
- 其他字段（如 `name`、`order_no`、`amount`）保持原样

### 10.2 通过API查询验证解密

通过API查询返回的数据中，加密字段会自动解密显示原始值。

## 11. 常见问题

### 11.1 密钥配置问题

**问题**: 启动时报密钥相关错误
**解决**: 确保设置了正确的环境变量或配置了有效的密钥

```yaml
# 确保密钥长度符合要求（AES需要16、24或32字节）
securt-kit:
  encrypt:
    key: "your-secret-key-32-chars-long"
```

### 11.2 字段类型问题

**问题**: 加密字段解密失败
**解决**: 确保数据库字段类型支持存储加密后的数据

```sql
-- 建议使用VARCHAR或TEXT类型
ALTER TABLE user_info MODIFY COLUMN phone VARCHAR(255);
ALTER TABLE user_info MODIFY COLUMN email VARCHAR(255);
```

### 11.3 性能问题

**问题**: 大量数据查询时性能较慢
**解决**: 考虑使用缓存或优化查询

```yaml
# 启用缓存
securt-kit:
  encrypt:
    cache:
      enabled: true
      size: 1000
      expire: 1h
```

## 12. 下一步

1. **阅读详细文档**: 查看 `字段加密解密方案设计.md` 了解完整的设计方案
2. **查看实现指南**: 查看 `实现指南.md` 了解具体的实现细节
3. **自定义扩展**: 根据需求自定义加密算法或密钥管理策略
4. **性能优化**: 根据实际使用情况优化性能和缓存策略
5. **安全加固**: 加强密钥管理和安全策略 