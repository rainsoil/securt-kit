# 字段加密解密使用示例

## 1. 配置说明

### 1.1 配置文件方式

在 `application.yml` 中配置：

```yaml
securt-kit:
  encrypt:
    enabled: true
    algorithm: AES
    key: ${ENCRYPT_KEY:your-secret-key-32-chars-long}
    patternType: POJO  # DB 或 POJO
    fields:
      user:
        - phone
        - email
        - id_card
      order:
        - customer_name
        - customer_phone
        - delivery_address
      payment:
        - card_number
        - cvv
        - account_number
    exclude-tables:
      - system_config
      - log_info
    key-rotation:
      enabled: false
      interval: 30
    cache:
      enabled: true
      size: 1000
      expire: 1
```

### 1.2 注解方式

在实体类字段上使用 `@EncryptField` 注解：

```java
@Data
public class UserEntity {
    private Long id;
    
    @EncryptField
    private String phone;
    
    @EncryptField(algorithm = "AES")
    private String email;
    
    @EncryptField(algorithm = "DES")
    private String idCard;
    
    private String username; // 不加密字段
    private String address;  // 不加密字段
}
```

## 2. 实体类定义

### 2.1 用户实体类

```java
package com.example.entity;

import com.chu7.securtkit.encrypt.annotation.EncryptField;
import lombok.Data;

@Data
public class UserEntity {
    private Long id;
    
    private String username;
    
    @EncryptField
    private String phone;
    
    @EncryptField(algorithm = "AES")
    private String email;
    
    @EncryptField(algorithm = "DES")
    private String idCard;
    
    private String address;
    
    private String createTime;
    private String updateTime;
}
```

### 2.2 订单实体类

```java
package com.example.entity;

import com.chu7.securtkit.encrypt.annotation.EncryptField;
import lombok.Data;

@Data
public class OrderEntity {
    private Long id;
    
    private String orderNo;
    
    @EncryptField
    private String customerName;
    
    @EncryptField
    private String customerPhone;
    
    @EncryptField
    private String deliveryAddress;
    
    private BigDecimal amount;
    private String status;
    private String createTime;
}
```

## 3. Mapper接口

### 3.1 用户Mapper

```java
package com.example.mapper;

import com.example.entity.UserEntity;
import org.apache.ibatis.annotations.*;

import java.util.List;

@Mapper
public interface UserMapper {
    
    @Insert("INSERT INTO user(username, phone, email, id_card, address) " +
            "VALUES(#{username}, #{phone}, #{email}, #{idCard}, #{address})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insert(UserEntity user);
    
    @Select("SELECT * FROM user WHERE id = #{id}")
    UserEntity selectById(Long id);
    
    @Select("SELECT * FROM user WHERE phone = #{phone}")
    UserEntity selectByPhone(String phone);
    
    @Select("SELECT * FROM user WHERE email = #{email}")
    UserEntity selectByEmail(String email);
    
    @Update("UPDATE user SET username=#{username}, phone=#{phone}, " +
            "email=#{email}, id_card=#{idCard}, address=#{address} " +
            "WHERE id=#{id}")
    int update(UserEntity user);
    
    @Delete("DELETE FROM user WHERE id = #{id}")
    int deleteById(Long id);
    
    @Select("SELECT * FROM user")
    List<UserEntity> selectAll();
}
```

### 3.2 订单Mapper

```java
package com.example.mapper;

import com.example.entity.OrderEntity;
import org.apache.ibatis.annotations.*;

import java.util.List;

@Mapper
public interface OrderMapper {
    
    @Insert("INSERT INTO orders(order_no, customer_name, customer_phone, " +
            "delivery_address, amount, status) " +
            "VALUES(#{orderNo}, #{customerName}, #{customerPhone}, " +
            "#{deliveryAddress}, #{amount}, #{status})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insert(OrderEntity order);
    
    @Select("SELECT * FROM orders WHERE id = #{id}")
    OrderEntity selectById(Long id);
    
    @Select("SELECT * FROM orders WHERE customer_phone = #{customerPhone}")
    List<OrderEntity> selectByCustomerPhone(String customerPhone);
    
    @Update("UPDATE orders SET customer_name=#{customerName}, " +
            "customer_phone=#{customerPhone}, delivery_address=#{deliveryAddress}, " +
            "amount=#{amount}, status=#{status} WHERE id=#{id}")
    int update(OrderEntity order);
}
```

## 4. Service层

### 4.1 用户服务

```java
package com.example.service;

import com.example.entity.UserEntity;
import com.example.mapper.UserMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * 创建用户
     * 手机号、邮箱、身份证号会自动加密
     */
    public Long createUser(UserEntity user) {
        userMapper.insert(user);
        return user.getId();
    }
    
    /**
     * 根据ID查询用户
     * 加密字段会自动解密
     */
    public UserEntity getUserById(Long id) {
        return userMapper.selectById(id);
    }
    
    /**
     * 根据手机号查询用户
     * 查询条件会自动加密，结果会自动解密
     */
    public UserEntity getUserByPhone(String phone) {
        return userMapper.selectByPhone(phone);
    }
    
    /**
     * 根据邮箱查询用户
     * 查询条件会自动加密，结果会自动解密
     */
    public UserEntity getUserByEmail(String email) {
        return userMapper.selectByEmail(email);
    }
    
    /**
     * 更新用户信息
     * 加密字段会自动加密
     */
    public boolean updateUser(UserEntity user) {
        return userMapper.update(user) > 0;
    }
    
    /**
     * 删除用户
     */
    public boolean deleteUser(Long id) {
        return userMapper.deleteById(id) > 0;
    }
    
    /**
     * 查询所有用户
     * 加密字段会自动解密
     */
    public List<UserEntity> getAllUsers() {
        return userMapper.selectAll();
    }
}
```

### 4.2 订单服务

```java
package com.example.service;

import com.example.entity.OrderEntity;
import com.example.mapper.OrderMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    /**
     * 创建订单
     * 客户姓名、手机号、地址会自动加密
     */
    public Long createOrder(OrderEntity order) {
        orderMapper.insert(order);
        return order.getId();
    }
    
    /**
     * 根据ID查询订单
     * 加密字段会自动解密
     */
    public OrderEntity getOrderById(Long id) {
        return orderMapper.selectById(id);
    }
    
    /**
     * 根据客户手机号查询订单
     * 查询条件会自动加密，结果会自动解密
     */
    public List<OrderEntity> getOrdersByCustomerPhone(String customerPhone) {
        return orderMapper.selectByCustomerPhone(customerPhone);
    }
    
    /**
     * 更新订单
     * 加密字段会自动加密
     */
    public boolean updateOrder(OrderEntity order) {
        return orderMapper.update(order) > 0;
    }
}
```

## 5. Controller层

### 5.1 用户控制器

```java
package com.example.controller;

import com.example.entity.UserEntity;
import com.example.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @PostMapping
    public Long createUser(@RequestBody UserEntity user) {
        return userService.createUser(user);
    }
    
    @GetMapping("/{id}")
    public UserEntity getUserById(@PathVariable Long id) {
        return userService.getUserById(id);
    }
    
    @GetMapping("/phone/{phone}")
    public UserEntity getUserByPhone(@PathVariable String phone) {
        return userService.getUserByPhone(phone);
    }
    
    @GetMapping("/email/{email}")
    public UserEntity getUserByEmail(@PathVariable String email) {
        return userService.getUserByEmail(email);
    }
    
    @PutMapping("/{id}")
    public boolean updateUser(@PathVariable Long id, @RequestBody UserEntity user) {
        user.setId(id);
        return userService.updateUser(user);
    }
    
    @DeleteMapping("/{id}")
    public boolean deleteUser(@PathVariable Long id) {
        return userService.deleteUser(id);
    }
    
    @GetMapping
    public List<UserEntity> getAllUsers() {
        return userService.getAllUsers();
    }
}
```

### 5.2 订单控制器

```java
package com.example.controller;

import com.example.entity.OrderEntity;
import com.example.service.OrderService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping
    public Long createOrder(@RequestBody OrderEntity order) {
        return orderService.createOrder(order);
    }
    
    @GetMapping("/{id}")
    public OrderEntity getOrderById(@PathVariable Long id) {
        return orderService.getOrderById(id);
    }
    
    @GetMapping("/customer/{phone}")
    public List<OrderEntity> getOrdersByCustomerPhone(@PathVariable String phone) {
        return orderService.getOrdersByCustomerPhone(phone);
    }
    
    @PutMapping("/{id}")
    public boolean updateOrder(@PathVariable Long id, @RequestBody OrderEntity order) {
        order.setId(id);
        return orderService.updateOrder(order);
    }
}
```

## 6. 测试示例

### 6.1 创建用户测试

```java
@Test
public void testCreateUser() {
    UserEntity user = new UserEntity();
    user.setUsername("张三");
    user.setPhone("13800138000");
    user.setEmail("zhangsan@example.com");
    user.setIdCard("110101199001011234");
    user.setAddress("北京市朝阳区");
    
    Long userId = userService.createUser(user);
    assertNotNull(userId);
    
    // 查询用户，验证加密字段已自动解密
    UserEntity savedUser = userService.getUserById(userId);
    assertEquals("张三", savedUser.getUsername());
    assertEquals("13800138000", savedUser.getPhone());
    assertEquals("zhangsan@example.com", savedUser.getEmail());
    assertEquals("110101199001011234", savedUser.getIdCard());
    assertEquals("北京市朝阳区", savedUser.getAddress());
}
```

### 6.2 查询用户测试

```java
@Test
public void testQueryUserByPhone() {
    // 先创建用户
    UserEntity user = new UserEntity();
    user.setUsername("李四");
    user.setPhone("13900139000");
    user.setEmail("lisi@example.com");
    user.setIdCard("110101199002022345");
    user.setAddress("上海市浦东新区");
    
    userService.createUser(user);
    
    // 根据手机号查询，验证查询条件自动加密
    UserEntity foundUser = userService.getUserByPhone("13900139000");
    assertNotNull(foundUser);
    assertEquals("李四", foundUser.getUsername());
    assertEquals("13900139000", foundUser.getPhone());
    assertEquals("lisi@example.com", foundUser.getEmail());
    assertEquals("110101199002022345", foundUser.getIdCard());
}
```

## 7. 数据库表结构

### 7.1 用户表

```sql
CREATE TABLE user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL COMMENT '用户名',
    phone VARCHAR(20) COMMENT '手机号（加密）',
    email VARCHAR(100) COMMENT '邮箱（加密）',
    id_card VARCHAR(20) COMMENT '身份证号（加密）',
    address VARCHAR(200) COMMENT '地址',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_phone (phone),
    INDEX idx_email (email)
) COMMENT '用户表';
```

### 7.2 订单表

```sql
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) NOT NULL COMMENT '订单号',
    customer_name VARCHAR(100) COMMENT '客户姓名（加密）',
    customer_phone VARCHAR(20) COMMENT '客户手机号（加密）',
    delivery_address VARCHAR(200) COMMENT '配送地址（加密）',
    amount DECIMAL(10,2) NOT NULL COMMENT '订单金额',
    status VARCHAR(20) NOT NULL COMMENT '订单状态',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_no (order_no),
    INDEX idx_customer_phone (customer_phone)
) COMMENT '订单表';
```

## 8. 注意事项

1. **密钥管理**: 确保加密密钥的安全性，不要硬编码在代码中
2. **字段类型**: 加密字段建议使用VARCHAR类型，长度要足够存储加密后的数据
3. **索引考虑**: 加密字段建立索引时需要考虑加密后的数据分布
4. **性能影响**: 加密解密操作会带来一定的性能开销，建议合理使用
5. **数据迁移**: 对已有数据进行加密时，需要编写迁移脚本
6. **备份恢复**: 确保加密密钥的备份，避免数据无法解密

## 9. 扩展功能

### 9.1 自定义加密算法

```java
@Component
public class CustomEncryptStrategy implements EncryptStrategy {
    @Override
    public String encrypt(String plainText, String key) {
        // 自定义加密逻辑
        return customEncrypt(plainText, key);
    }
    
    @Override
    public String decrypt(String cipherText, String key) {
        // 自定义解密逻辑
        return customDecrypt(cipherText, key);
    }
    
    @Override
    public String getAlgorithm() {
        return "CUSTOM";
    }
    
    @Override
    public boolean supports(String algorithm) {
        return "CUSTOM".equalsIgnoreCase(algorithm);
    }
}
```

### 9.2 自定义密钥管理器

```java
@Component
public class CustomKeyManager implements KeyManager {
    @Override
    public String getKey(String tableName, String fieldName) {
        // 从配置中心或密钥管理系统获取密钥
        return getKeyFromKeyManagementSystem(tableName, fieldName);
    }
    
    @Override
    public String getDefaultKey() {
        return getDefaultKeyFromSystem();
    }
    
    @Override
    public String rotateKey(String tableName, String fieldName) {
        // 实现密钥轮换逻辑
        return rotateKeyInSystem(tableName, fieldName);
    }
    
    @Override
    public boolean isKeyValid(String key) {
        return validateKeyInSystem(key);
    }
    
    @Override
    public String generateKey(String algorithm) {
        return generateKeyInSystem(algorithm);
    }
    
    @Override
    public void storeKey(String tableName, String fieldName, String key) {
        storeKeyInSystem(tableName, fieldName, key);
    }
}
```

通过以上示例，您可以快速上手使用字段加密解密功能，保护敏感数据的安全性。 